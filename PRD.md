# Product Requirements Document (PRD)
# Hexagonal Puzzle Game

**Версия:** 1.0
**Дата:** 20.01.2026
**Статус:** Draft

---

## 1. Обзор продукта

### 1.1 Описание игры
Hexagonal Puzzle Game — это браузерная головоломка с размещением фигур на шестиугольном поле. Игровой процесс основан на классической механике "три в ряд" и тетриса, адаптированных под гексагональную сетку. Игрок выбирает из трёх предложенных фигур и размещает их на поле, стремясь заполнить линии от края до края для их уничтожения и получения очков.

### 1.2 Целевая аудитория
- Возраст: 16-45 лет
- Любители казуальных головоломок
- Пользователи мобильных устройств и десктопов
- Аудитория платформ Яндекс.Игры, VK Games, CrazyGames

### 1.3 Ключевые метрики успеха
- Retention Day 1: ≥ 30%
- Retention Day 7: ≥ 10%
- Среднее время сессии: 5-10 минут
- eCPM (реклама): целевой показатель определяется платформой

---

## 2. Игровые механики

### 2.1 Игровое поле

**Тип поля:** Шестиугольная сетка (гексагональная)
**Размер поля:** 9 ячеек (сторона от угла до угла, диаметр)
**Система координат:** Кубические координаты (q, r, s) или осевые координаты
**Визуальная структура:**
- Плоская гексагональная сетка (pointy-top orientation)
- Центр поля является началом координат (0, 0, 0)
- Общее количество ячеек: 61 

### 2.2 Игровые фигуры

**Типы фигур:**
- Мономino: одиночный шестиугольник (1 клетка)
- Тетрамино: фигура из 4 шестиугольников

**Формы тетрамино (10 уникальных конфигураций):**

| Фигура | Координаты клеток | Описание |
|--------|-------------------|----------|
| Line | (0,0), (1,0), (2,0), (3,0) | Прямая линия из 4 клеток |
| Corner | (0,0), (1,0), (2,0), (0,1) | 3 клетки в ряд + 1 под углом 60° |
| Triangle | (0,0), (1,0), (2,0), (1,1) | Пирамида из 4 клеток |
| S | (1,0), (2,0), (0,1), (1,1) | S-форма (зигзаг) |
| Z | (0,0), (1,0), (1,1), (2,1) | Z-форма (обратный зигзаг) |
| Hook | (-1,0), (0,0), (1,0), (1,1) | Г-образная форма с изгибом |
| LongHook | (-1,0), (0,0), (1,0), (2,-1) | Удлинённая Г-форма |
| Boat | (-1,0), (0,-1), (1,-1), (1,0) | Трапециевидная форма |
| Rays | (0,0), (1,0), (0,-1), (-1,1) | Три луча из центра (вилка) |
| Monomino | (0,0) | Одиночная клетка |

**Всего уникальных фигур:** 10

**Цветовая схема фигур:**
- Каждая фигура при генерации получает случайный цвет из палитры
- Палитра цветов (10 ярких, контрастных цветов):
  - #4ECDC4 (бирюзовый)
  - #FF6B6B (красный)
  - #FFD93D (жёлтый)
  - #6BCB77 (зелёный)
  - #9B59B6 (фиолетовый)
  - #3498DB (синий)
  - #1ABC9C (бирюзовый тёмный)
  - #FF9F43 (оранжевый)
  - #E74C3C (тёмно-красный)
  - #2ECC71 (изумрудный)

### 2.3 Система появления фигур

**Механизм:**
- Одновременно отображаются 3 фигуры на выбор, вертикально в правой стороне экрана
- Новые фигуры появляются только после размещения текущей
- При израсходовании одной фигуры остальные две "всплывают" вверх, внизу генерируется новая фигура 

**Вероятности появления (веса):**
- Каждая фигура имеет вес вероятности, определяющий частоту её появления
- Веса используются в алгоритме взвешенной случайной генерации (weighted random)

**Дефолтные веса фигур:**
| Фигура | Вес | Описание |
|--------|-----|----------|
| Monomino | 3.0 | Одиночная клетка (высокий приоритет для заполнения дыр) |
| Line | 2.5 | Прямая линия (средний приоритет) |
| Corner | 2.0 | Угловая форма (средний приоритет) |
| Triangle | 1.5 | Треугольная форма (ниже приоритет) |
| S | 1.5 | S-форма (ниже приоритет) |
| Z | 1.5 | Z-форма (ниже приоритет) |
| Hook | 1.5 | Г-образная форма |
| LongHook | 1.0 | Удлинённая Г-форма |
| Boat | 1.0 | Трапециевидная форма |
| Rays | 1.0 | Три луча из центра |

**Динамическая корректировка весов:**
- Веса автоматически пересчитываются при каждом размещении фигуры
- Учитывается количество свободных ячеек на поле и их расположение
- Фигуры с меньшим количеством клеток получают повышенный вес при заполнении поля
- Фигуры, которые могут заполнить свободные области, получают повышенный вес

**Алгоритм динамической корректировки:**
1. Анализ свободных ячеек на поле
2. Оценка пригодности каждой фигуры для размещения в свободных областях
3. Увеличение веса фигур, которые могут заполнить "узкие" места
4. Уменьшение веса фигур, которые с высокой вероятностью не поместятся

**Формула расчёта динамического веса:**
```
final_weight = base_weight * placement_probability_factor * area_fill_factor
```
Где:
- `base_weight` — дефолтный вес фигуры
- `placement_probability_factor` — коэффициент вероятности размещения (0.1 - 2.0)
- `area_fill_factor` — коэффициент заполняемости свободных областей (0.5 - 2.0)

### 2.4 Размещение фигур

**Правила размещения:**
- Игрок может разместить фигуру на любой свободной комбинации ячеек
- Фигура должна полностью помещаться в границы поля
- Все клетки фигуры должны быть свободны
- После размещения фигура фиксируется на поле

**Взаимодействие:**
- Drag-and-drop с любой точки фигуры
- Предпросмотр позиции при наведении
- Визуальная индикация допустимого/недопустимого размера
- Звуковой фидбек при успешном размещении

### 2.5 Система линий

**Определение линии:**
- Линия — это непрерывный набор ячеек, выстроенный в ряд по одному из возможных векторов
- Линия считается заполненной, когда все её ячейки заняты фигурами
- Всего на поле существует 27 линий разного размера (от 5 до 9 ячеек)

**Механика уничтожения:**
- При размещении фигуры система проверяет все возможные линии, проходящие через занятые ячейки
- Если линия полностью заполнена, она уничтожается и освобождает ячейки
- Одно размещение может уничтожить несколько линий одновременно
- Уничтоженные линии приносят очки согласно системе бонусов

### 2.6 Система очков и бонусов

**Базовые очки:**
- За каждую размещённую клетку: 10 очков
- За каждую уничтоженную линию: 100 очков за самую маленькую линию из 5 клеток, +10 очков за каждую ячейку для бОльших линий. Например, для линии из 7 ячеек - 120 очков

**Комбобонусы:**
- 1 линия: x1 (базовый множитель)
- 2 линии: x1.5
- 3 линии: x2
- 4 линии: x3
- 5+ линий: x5

**Множитель комбо:**
- Увеличивается на 0.1 после каждого успешного хода
- Сбрасывается до 1.0 при ходе без уничтожения линий

**Конец игры:**
- Игра заканчивается, когда ни одна из трёх доступных фигур не может быть размещена
- Итоговый счёт = накопленные очки

---

## 3. Визуальные и звуковые эффекты

### 3.1 Эффекты при взятии фигуры

**Визуальные:**
- Подсветка выбранной фигуры (увеличение масштаба на 15%)
- Свечение по контуру фигуры (цвет: золотистый, duration: 200ms)
- Мягкая тень под фигурой
- Частицы приподнимаются над фигурой (parabolic motion)

**Звуковые:**
- Звук "pick" (мягкий щелчок, 150ms)
- Тональность: C5, громкость 70%

### 3.2 Эффекты при размещении фигуры

**Визуальные:**
- Анимация "падения" фигуры на позицию (ease-out, 150ms)
- Волна деформации поля (ripple effect, 300ms)
- Кратковременное свечение всех клеток фигуры (белый, 100ms)
- Мягкая вспышка в центре фигуры

**Звуковые:**
- Звук "place" (приглушённый удар, 200ms)
- Тональность: E4, громкость 60%

### 3.3 Эффекты при сгорании линии

**Визуальные:**
- Последовательная анимация (не одновременно):
  - Линия заполняется белым светом (fill animation, 150ms)
  - Эффект "трещины" по линии (crack pattern, 100ms)
  - Линия распадается на частицы (particle burst, 400ms)
  - Осколки разлетаются в 3D пространстве
- После распада: ячейки "отскакивают" обратно (elastic bounce, 300ms)

**Цветовая палитра эффектов:**
- Primary: #FFD700 (золотой)
- Secondary: #FF6B6B (коралловый)
- Accent: #4ECDC4 (бирюзовый)
- Particles: рандомные оттенки из текущей цветовой схемы

**Звуковые:**
- Звук "destroy" (электронный, 250ms)
- Тональность: глиссандо от G4 до C6
- Дополнительный слой: хорус эффект для множественных линий
- Громкость: 80%, увеличивается с количеством линий

### 3.4 UI эффекты

**Общие:**
- Мягкие переходы между экранами (300ms, ease-in-out)
- Плавные анимации кнопок (scale + shadow)
- Hover эффекты на интерактивных элементах

**Счёт:**
- Анимация изменения счёта (rolling numbers)
- Всплывающие "+100" при уничтожении линий
- Комбо индикатор с пульсацией

### 3.5 Цветовая схема

**Рекомендуемая палитра (dark theme):**
- Background: #1A1A2E
- Grid (empty cells): #16213E
- Grid (hover): #0F3460
- Cell borders: #533483
- Figures: яркие, контрастные цвета (4-6 вариаций)
- UI elements: #E94560

## 3.6 Элементы интерфейса (UI)

**Главный экран:**
- Логотип игры (центр верхней части)
- Кнопка "Играть" (Play) — основная CTA
- Кнопка "Рейтинг" (Leaderboard) — опционально
- Кнопка "Настройки" (Settings) — иконка шестерёнки
- Индикатор версии игры 

**Экран игры:**
- Игровое поле (центр экрана)
- Счёт (score) — верхняя часть экрана, крупно
- Текущая комбинация (combo multiplier) — под счётом
- Панель фигур (3 слота) — нижняя часть экрана
- Кнопка паузы (иконка паузы) — верхний правый угол
- Индикатор прогресса линий (опционально)

**Панель фигур:**
- 3 слота для фигур
- Текущая выбранная фигура — подсветка
- Drag-and-drop preview при перетаскивании
- Счётчик фигур (если нужно ограничить)

**Экран Game Over:**
- Итоговый счёт (крупно, по центру)
- Лучший результат (best score) — под итоговым
- Кнопка "Заново" (Play Again) — основная CTA
- Кнопка "В меню" (Menu)
- Кнопка "Смотреть рекламу x2" (Rewarded Ad) — если применимо
- Анимация "лучший результат" при новом рекорде

**Экран настроек:**
- Переключатель звука (Sound On/Off)
- Переключатель музыки (Music On/Off)
- Переключатель вибрации (Vibration) — для мобильных
- Кнопка "О игре" (About)
- Кнопка "Политика конфиденциальности" — если применимо
- Кнопка "Закрыть" (Close/X)

**Всплывающие элементы (popups):**
- Уведомление о сгорании линий (+очки)
- Уведомление о комбо (x2, x3 и т.д.)
- "Новая игра" диалог (при выходе из игры)
- "Реклама недоступна" (если ad не загрузился)
- Ошибка загрузки

**Индикаторы:**
- Score counter — анимированное изменение
- Combo indicator — пульсация при умножении
- High score badge — появляется при превышении
- Ad loading indicator — спиннер при загрузке рекламы

**Адаптивность UI:**
- Mobile: кнопки минимум 44x44px (touch target)
- Desktop: hover эффекты, cursor pointer
- Поддержка landscape/portrait ориентаций
- Safe area для notch/ Dynamic Island

---

## 4. Технические требования

### 4.1 Архитектура рендеринга

#### Вариант A: Vanilla JS + Canvas API (Рекомендуемый)

**Преимущества:**
- Минимальный размер билда: 15-25 KB (gzipped)
- Отсутствие внешних зависимостей
- Полный контроль над производительностью
- Идеально для Yandex Games (минимизация времени загрузки)

**Недостатки:**
- Больше кода для реализации эффектов
- Сложнее поддерживать
- Ограниченные возможности для сложных анимаций

**Совместимость:** Все современные браузеры, включая WebGL 1.0+

#### Вариант B: PixiJS

**Преимущества:**
- WebGL-ускоренный рендеринг
- Встроенные эффекты (filters, particles)
- Проще реализовать сложные визуалы
- Размер: ~500 KB (minified, gzipped ~150 KB)

**Недостатки:**
- Дополнительная зависимость
- Больший размер билда
- Избыточность для простой механики

**Рекомендация:** Использовать если планируются сложные пост-эффекты

#### Вариант C: Phaser 3

**Преимущества:**
- Полноценный игровой фреймворк
- Встроенные системы физики, звука, UI
- Отличная документация

**Недостатки:**
- Размер: ~600 KB minified
- Избыточность для казуальной головоломки
- Дольше время загрузки

#### Вариант D: Three.js

**Преимущества:**
- 3D-рендеринг
- Потенциал для 3D-версии игры

**Недостатки:**
- Размер: ~600 KB minified
- Избыточность для 2D-игры
- Сложнее для разработки

### 4.2 Рекомендуемое решение: Vanilla JS + Canvas API

**Обоснование:**
1. Минимальный размер критичен для Яндекс.Игры и подобных платформ
2. Гексогональная сетка — математически простая структура
3. Все эффекты реализуемы через Canvas API
4. Быстрая загрузка = лучший Retention
5. Полная совместимость с WebGL при необходимости

**Целевой размер билда:** 20-30 KB (gzipped)

### 4.3 Производительность

**Целевые показатели:**
- FPS: стабильные 60 FPS на 60Hz мониторах
- Время загрузки: < 1.5 секунды (3G/4G)
- Память: < 100 MB RAM

**Оптимизации:**
- Кэширование рендеринга статических элементов
- RequestAnimationFrame для анимаций
- Object pooling для частиц
- Разделение на critical и non-critical ресурсы
- Lazy loading звуковых эффектов

### 4.4 Адаптивность

**Поддерживаемые разрешения:**
- Mobile: 320x480 до 2k (portrait/landscape)
- Desktop: 1024x768 до 4k
- Tablet: 768x1024 до 1366x1024

**Особенности:**
- Responsive Canvas (fit to window)
- Touch events для мобильных
- Mouse events для десктопа
- Поддержка retina/HiDPI дисплеев

---

## 5. Монетизация

### 5.1 Рекламная модель

**Типы рекламы:**
1. Interstitial (межстраничная) — между уровнями/сессиями
2. Rewarded Video (видео с наградой) — основная механика
3. Banner (опционально) — для десктоп версии

### 5.2 Rewarded Video Ads

**Механика 1: Дополнительные фигуры**
- Триггер: когда игрок не может разместить доступные фигуры
- Предложение: "Посмотреть рекламу для получения 3 новых фигур"
- Награда: полностью новая тройка фигур
- Частота: не чаще 1 раза за игровую сессию

**Механика 2: Удвоение бонуса**
- Триггер: экран Game Over
- Предложение: "Посмотреть рекламу, чтобы удвоить итоговый счёт"
- Награда: финальный счёт × 2
- Частота: каждый раз при проигрыше

**Механика 3: Продление игры (опционально)**
- Триггер: перед завершением игры
- Предложение: "Одна попытка продолжить игру"
- Награда: +1 жизнь / возможность перезапустить текущую сессию

### 5.3 Реализация

**Интеграция с PlayGama Plugin:**

PlayGama — это универсальный плагин-обёртка для HTML5 игр, который обеспечивает единый API для работы с рекламой и платформенными функциями на всех поддерживаемых платформах.

```javascript
// Пример структуры
async showRewardedAd(actionType) {
    try {
        const ad = await PlayGamaSDK.showRewardedAd();
        if (ad.wasShown) {
            // Записать событие аналитики
            this.analytics.track('ad_watched', { actionType });
            // Выдать награду
            this.giveReward(actionType);
        }
    } catch (error) {
        console.error('Ad failed:', error);
    }
}
```

**Поддерживаемые платформы через PlayGama:**
- Яндекс.Игры
- VK Games
- CrazyGames
- Poki
- И другие платформы

**Преимущества PlayGama:**
- Единый API для всех платформ
- Автоматическое определение платформы
- Встроенная аналитика
- Fallback механизмы

### 5.4 Аналитика и метрики

**Отслеживаемые события:**
- `ad_request` — запрос на показ рекламы
- `ad_shown` — реклама показана
- `ad_completed` — реклама просмотрена до конца
- `ad_skipped` — реклама пропущена
- `ad_reward_claimed` — награда получена
- `conversion_rate` = completed / shown

**Целевые показатели:**
- Rewarded completion rate: > 70%
- ARPU: определяется платформой

### 5.5 Сбор аналитики

**Отслеживаемые события (gameplay):**
- `game_start` — начало новой игры
- `game_over` — завершение игры (параметры: score, duration, lines_destroyed)
- `figure_place` — размещение фигуры (параметры: figure_type, rotation)
- `line_destroy` — уничтожение линии (параметры: lines_count, score_gained)
- `combo` — комбо (параметры: combo_count)
- `score_milestone` — достижение очкового рубежа (1000, 5000, 10000 и т.д.)

**Отслеживаемые события (engagement):**
- `session_start` — начало игровой сессии
- `session_end` — завершение сессии (параметры: duration)
- `time_played` — общее время игры (с периодичностью 5 мин)
- `return_to_game` — возврат в игру после перерыва

**Отслеживаемые события (monetization):**
- `ad_request` — запрос на показ рекламы
- `ad_shown` — реклама показана
- `ad_completed` — реклама просмотрена до конца
- `ad_skipped` — реклама пропущена
- `ad_reward_claimed` — награда получена (параметры: reward_type)
- `conversion_rate` = completed / shown

**Инструменты аналитики:**
- [GameAnalytics](https://gameanalytics.com/) — основная платформа аналитики
- [PlayGama SDK](https://wiki.playgama.com/playgama/sdk/engines/core-plain-js/intro) — интеграция с рекламными событиями
- Унифицированный event bus для интеграции с AppsFlyer, Adjust (опционально)

**Целевые метрики:**
- DAU/MAU (daily/monthly active users)
- Retention Day 1/7/30
- Average session duration
- Sessions per user per day
- Lifetime value (LTV)
- ARPU/ARPDAU

---

## 6. Платформенная интеграция

### 6.1 PlayGama Plugin

**Описание:**
PlayGama — это универсальный плагин-обёртка для HTML5 игр, который обеспечивает единый API для работы с рекламой и платформенными функциями на всех поддерживаемых платформах.

**Поддерживаемые платформы:**
- Яндекс.Игры
- VK Games
- CrazyGames
- Poki
- И другие платформы

**Функциональность:**
- Единый API для всех платформ
- Автоматическое определение текущей платформы
- Интеграция рекламы (Interstitial, Rewarded, Banner)
- Сохранение прогресса (кросс-платформенное)
- Лидерборды
- Авторизация (опционально)
- Payments API (опционально)

**Размер и производительность:**
- Максимальный размер билда: 1024 KB (рекомендуется < 500 KB)
- Время загрузки до первого взаимодействия: < 3 секунды
- Обязательное отображение "Загрузка..." лоадера

**Преимущества:**
- Не нужно писать отдельный код для каждой платформы
- Автоматические fallback механизмы
- Консистентный UX на всех платформах
- Упрощённое тестирование

---

## 7. Roadmap разработки

### Phase 1: MVP (2-3 недели)
- [ ] Базовая гексогональная сетка (диаметр 9 ячеек, 61 клетка)
- [ ] Генерация и отображение фигур (мономино + тетрамино)
- [ ] Drag-and-drop размещение
- [ ] Система определения линий
- [ ] Базовые звуковые эффекты
- [ ] Счёт и Game Over
- [ ] Адаптивный Canvas

### Phase 2: Визуал и FX (1-2 недели)
- [ ] Анимации взятия/размещения фигур
- [ ] Эффекты сгорания линий
- [ ] Система частиц
- [ ] UI анимации
- [ ] Цветовые темы (dark/light)

### Phase 3: Монетизация (1 неделя)
- [ ] Интеграция PlayGama Plugin
- [ ] Rewarded Ads — дополнительные фигуры
- [ ] Rewarded Ads — удвоение бонуса
- [ ] Аналитика рекламных событий

### Phase 4: Полировка (1 неделя)
- [ ] Тестирование на всех целевых платформах
- [ ] Оптимизация размера билда
- [ ] A/B тестирование визуалов
- [ ] Balancing (сложность, бонусы)
- [ ] Документация

### Phase 5: Soft Launch (1 неделя)
- [ ] Публикация на платформах через PlayGama (Яндекс.Игры, VK, CrazyGames, Poki)
- [ ] Мониторинг метрик (retention, ARPU, eCPM)
- [ ] Исправление критических багов
- [ ] Сбор обратной связи

---

## 8. Требования к качеству

### 8.1 Тестирование

**Unit тесты:**
- Логика гексогональной сетки
- Определение линий
- Генерация фигур
- Подсчёт очков

**Integration тесты:**
- Взаимодействие Canvas с game loop
- Rewarded Ads integration
- Сохранение/загрузка состояния

**E2E тесты:**
- Полный игровой цикл
- Game Over scenarios
- Ad completion flow

### 8.2 Browser Support

**Minimum:**
- Chrome 70+
- Firefox 65+
- Safari 12+
- iOS Safari 12+
- Android Chrome 70+

**Рекомендуемый:**
- Chrome 90+
- Safari 15+
- Edge 90+

---

## 9. Рекомендации по реализации

### 9.1 Математика гексогональной сетки

Для pointy-top ориентации:
```javascript
// Осевые координаты (q, r)
// Третья координата: s = -q - r

// Перевод в пиксели:
function hexToPixel(q, r, size) {
    const x = size * (Math.sqrt(3) * q + Math.sqrt(3)/2 * r);
    const y = size * (3/2 * r);
    return { x, y };
}

// Расстояние между гексами:
function hexDistance(a, b) {
    return (Math.abs(a.q - b.q) + 
            Math.abs(a.q + a.r - b.q - b.r) + 
            Math.abs(a.r - b.r)) / 2;
}
```

### 9.2 Оптимизация рендеринга

**Canvas optimization checklist:**
- Использовать offscreen canvas для статических элементов
- batch draw calls
- Избегать создания объектов в game loop
- Использовать typed arrays для particle systems

### 9.3 Asset optimization

**Звуки:**
- Web Audio API для синтеза (минимальный размер)
- Или сжатые OGG/WebM файлы (< 50KB все sounds)
- Lazy loading звуков

**Графика:**
- Использовать процедурную генерацию в Canvas
- Избегать спрайтов где возможно
- SVG для иконок UI

---

## 10. Риски и mitigation

| Риск | Вероятность | Влияние | Mitigation |
|------|-------------|---------|------------|
| Низкий retention | Средняя | Высокое | A/B тестирование сложности, социальные функции |
| Низкий eCPM | Среднее | Среднее | Диверсификация платформ, тестирование ad placement |
| Технические проблемы с WebGL | Низкое | Среднее | Graceful fallback на Canvas 2D |
| Проблемы с кросс-платформенностью | Среднее | Среднее | Extensive testing на реальных устройствах |
| Баланс игры (слишком легко/сложно) | Высокое | Среднее | Soft launch + итеративный balancing |

---

## 11. Приложения

### A. Глоссарий
- **Hex/Гекс:** Отдельная шестиугольная ячейка поля
- **Pointy-top:** Ориентация гекса с вершиной вверху
- **Flat-top:** Ориентация гекса с гранью вверху
- **Axial coordinates:** Система координат (q, r)
- **Cube coordinates:** Система координат (q, r, s)
- **Rewarded Video:** Рекламное видео с добровольным просмотром и наградой
- **eCPM:** Effective Cost Per Mille (доход за 1000 показов)

### B. Референсы
- [Hex FRVR](https://hex.frvr.com/) — основной референс геймплея
- [Hexic](https://en.wikipedia.org/wiki/Hexic) (Microsoft Game Studios) — классическая гексоголоволомка
- [Hexellent](https://poki.com/en/g/hexellent) (Poki) — похожая механика

---

**Документ подготовлен для команды разработки.**

**Следующие шаги:**
1. Согласование требований с stakeholders
2. Техническое задание (детальная спецификация)
3. Начало разработки Phase 1
